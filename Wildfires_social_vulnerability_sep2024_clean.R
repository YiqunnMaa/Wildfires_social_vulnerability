#------------------------------------------------------------------------------#
#--------Wildfires social vulnerability --------------------------#   
#-------------------------R code-----------------------------------------------#
#------------------------Date:9/11/24-------------------------------------#
#-----------------------------Lara Schwarz-------------------------------------#
#------------------------------------------------------------------------------#

#-------------------------------------Load packages----------------------
library(panelView)
library(dplyr)
library(gsynth)
library(ggplot2)
library(cowplot)
library(rstudioapi)
library(knitr)
library(coefplot)
library(sjPlot)
library(svglite)
library(sf)
library(dplyr)
library(ggmap)
library(broom)
library(ggpubr)
library(haven)
library(jtools)
library(stringr)
library(metafor)
library(broom.mixed)
library(tidyverse)
library(devtools)
library(lubridate)
library(aweek)
library(choroplethrZip)
library("padr")
library(tsibble)
library(readr)
library(usethis)
library(gitcreds)
library(MetBrewer)
library(choroplethrMaps)
library(meta)

#---------------------------------Function to highlight a county------------------------------  
highlight_county = function(county_fips)
{
  library(choroplethrMaps)
  data(county.map, package="choroplethrMaps", envir=environment())
  df = county.map[county.map$region %in% county_fips, ]
  geom_polygon(data=df, aes(long, lat, group = group), color = "black", fill=NA, size = 1)
}


#---------------------------------Loading the data------------------------------
Smoke <- read.csv("D:/DATA/data_hub/zcta/Daily_environmental/CA ZIP/CAzip_wfpm25_2006to2020.csv")
other_env_data <- read.csv("D:/DATA/data_hub/zcta/Daily_environmental/CA ZIP/prdctrs_06to21.csv")

CA_zctas <- read.csv("D:/OSHPD/zctas_combo_2010_and_2000_CZ.csv")
OSHPD_hosp <- read.csv("D:/OSHPD/combo_99_19_patzip_cvd_resp_EM.csv")
CA_countynames <- read.csv("D:/Lara/wildfires_social_vulnerability/Data/CA_counties_name_fips.csv")

#---------------------------------Data prep------------------------------
## Data file with list of California zctas in each County
CA_zctas_counties <- CA_zctas %>%
  select(ZCTA5, COUNTY_1)

## Data file with countynames and codes
CA_countynames <- CA_countynames %>%
  select(countyname, FIPS)

other_env_data$date<-as.Date(other_env_data$date)
Smoke$date<-as.Date(Smoke$date)

## merging in County level information to smoked data
Smoke_data <- left_join(Smoke, CA_zctas_counties, 
                        by = c("zip_code" = "ZCTA5"))
Smoke_data <- left_join(Smoke_data, CA_countynames, 
                        by = c("COUNTY_1" = "FIPS"))

Smoke_data <- left_join(Smoke_data, other_env_data, 
                        by = c("zip_code" = "zip", "date"))


# drop observations that are in no County
Smoke_data<-Smoke_data[!(Smoke_data$COUNTY_1==0),]

Smoke_data$date<-as.Date(Smoke_data$date)
Smoke_data$year <- year(Smoke_data$date) #new variable for year
Smoke_data$month <- month(Smoke_data$date) #new variable for month
Smoke_data$day <- day(Smoke_data$date) #new variable for day

summary(Smoke_data$wf_pm25)
sum(Smoke_data$wf_pm25<10 & Smoke_data$wf_pm25>0 ) # ZCTA-days are less than 10 ug/m^3
sum(Smoke_data$wf_pm25<5 & Smoke_data$wf_pm25>0 ) # ZCTA-days are less than 5 ug/m^3
sum(Smoke_data$wf_pm25<1 & Smoke_data$wf_pm25>0 ) # ZCTA-days are less than 1 ug/m^3

#any day with less than 5 ug/m^3 wildfire smoke is not considered smoke day
Smoke_data$wf_pm25[Smoke_data$wf_pm25<5] <- 0   # remove smoke days that are less than 5 ug/m^3
Smoke_data$wf_25_bin<- ifelse(Smoke_data$wf_pm25 > 0, 1, 0) # make binary smoke exposure variable

# find which year has most wildfire smoke
Smoke_data %>%
  group_by(year) %>%
  summarise(mean_wfpm25 = mean(wf_pm25))

# find which year has most wildfire smoke exposed ZCTAS
Smoke_data %>%
  group_by(year) %>%
  summarise(zctas_wfpm25 = mean(wf_25_bin))

# 2018 is year with highest average pm2.5 from wildfire smoke throughout CA zip codes (after 2020)
Smoke_data_2018 <- Smoke_data[which(Smoke_data$year==2018),]

# find which month has most zctas with wildfire smoke in 2018
Smoke_data_2018 %>%
  group_by(month) %>%
  summarise(wfpm25_zips = mean(wf_25_bin))

# November is a month with some of highest average pm2.5 from wildfire smoke throughout CA zip codes in 2018
# create dataset with average smoke days by zcta
Smoke_data_nov2018 <- Smoke_data_2018[which(Smoke_data_2018$month==11),]
Smoke_data_nov2018_mean <- Smoke_data_nov2018 %>%
  group_by(zip_code, countyname) %>%
  summarize(value= mean(wf_25_bin))

# find which days has most zctas with wildfire smoke in Nov 2018
Smoke_data_nov2018_days<-Smoke_data_nov2018 %>%
  group_by(day) %>%
  summarise(wfpm25_zips = mean(wf_25_bin))

# Create variables needed for choropleth map (region & value)
Smoke_data_nov2018_mean$region<- as.character(Smoke_data_nov2018_mean$zip_code)

# Choropleth map of zip codes with smoke
zip_choropleth(Smoke_data_nov2018_mean,
               state_zoom = "california",
               title      = "Zip codes with Smoke",
               legend     = "Smoke")

# create dataset with average smoke days by zcta in 2018
Smoke_zctas_2018 <- Smoke_data_2018 %>%
  group_by(date) %>%
  summarize(value= mean(wf_25_bin))

Smoke_zctas_2018$day <- yday(Smoke_zctas_2018$date) #new variable for day

# scatterplot of wildfire exposed zctas through time in 2018
Smoke_zctas_2018 %>%
  ggplot(aes(x = day, y = value)) +
  geom_line(color = "blue", size = 1, linetype = "solid") +
  xlab("Day of Year (2018)") +
  ylab("% of ZCTAs Exposed") +
  ggtitle("Exposure of ZCTAs Over the Year 2018") +
  theme_minimal() 

# creating dataset with average smoke days by zcta
Smoke_data_nov_1_7_2018 <- Smoke_data_nov2018[which(Smoke_data_nov2018$day>0 & Smoke_data_nov2018$day<8),]
Smoke_data_nov_1_7_2018_mean <- Smoke_data_nov_1_7_2018 %>%
  group_by(zip_code) %>%
  summarize(value= mean(wf_25_bin))

# creating dataset with average smoke days by zcta
Smoke_data_nov_8_14_2018 <- Smoke_data_nov2018[which(Smoke_data_nov2018$day>7 & Smoke_data_nov2018$day<15),]
Smoke_data_nov_8_14_2018_mean <- Smoke_data_nov_8_14_2018 %>%
  group_by(zip_code, countyname) %>%
  summarize(value= mean(wf_25_bin), tmax=mean(tmmx), prec=mean(pr), hum=mean(spec_humidity), shrtwv_rad=mean(shrtwv_rad), wind=mean(wind.velocity) )

# Create variables needed for choropleth map (region & value)
Smoke_data_nov_8_14_2018_mean$region<- as.character(Smoke_data_nov_8_14_2018_mean$zip_code)
Smoke_data_nov_1_7_2018_mean$region<- as.character(Smoke_data_nov_1_7_2018_mean$zip_code)

# select CA counties
dd_fips = c(06097,06045, 06023, 06015, 06055, 06041, 06033, 06105, 06053, 06081, 06075, 06001, 06013, 06095, 06087, 
            06079, 06029,06085, 06069, 06083, 06037, 06059, 06111, 06073, 06071, 06065, 06057, 06061, 06101, 06007,
            06115, 06011, 06021,  06089, 06103, 06019, 06047, 06067, 06077, 06009, 06109, 06043, 06099, 06005, 
            06113, 06017, 06031, 06107, 06025, 06027, 06093, 06049, 06051, 06035, 06003, 06039, 06063, 06091)

# Choropleth map of zip codes with smoke before wildfires started
map_pre_smoke<-zip_choropleth(Smoke_data_nov_1_7_2018_mean,
                              state_zoom = "california",
                              title      = "Zip codes with Smoke Nov 1-7, 2018",
                              legend     = "Smoke days (% of week exposed)",
                              num_colors= 1 )+
  highlight_county(dd_fips)

# Choropleth map of zip codes with smoke
map_post_smoke<-zip_choropleth(Smoke_data_nov_8_14_2018_mean,
                               state_zoom = "california",  
                               title      = "Zip codes with Smoke Nov 8-14, 2018",
                               legend     = "Smoke days (% of week exposed)",
                               num_colors= 1)+
  highlight_county(dd_fips)

map_pre_smoke+map_post_smoke

## OSHPD hospitalization data processing

OSHPD_hosp$year <- year(OSHPD_hosp$admtdate) #new variable for year

# restrict to 2018 (year with highest average pm2.5 from wildfire smoke throughout CA zip codes (after 2020))
hosp_2018 <- OSHPD_hosp[which(OSHPD_hosp$year==2018),]

hosp_2018$month <- month(hosp_2018$admtdate) #new variable for month
hosp_2018$day <- day(hosp_2018$admtdate) #new variable for day
hosp_2018$week <- week(hosp_2018$admtdate) #new variable for week

hosp_2018 <- hosp_2018 %>%
  select(patzip, admtdate, circulatory, respiratory, year, month, day)

# merge hospitalization data with county level information and smoke
CA_hosp_2018 <- left_join( hosp_2018, CA_zctas_counties, 
                           by = c( "patzip"="ZCTA5" ))

CA_hosp_2018$date<-as.Date(CA_hosp_2018$admtdate)

CA_hosp_2018$week2<-date2week(CA_hosp_2018$date, week_start = 4, floor_day = TRUE )

#CA_hosp <- left_join( CA_hosp_2018, Smoke_data_nov_8_14_2018_mean,
# by = c("ZCTA5" = "zip_code"))

#CA_hosp <- left_join( CA_hosp_2018, Smoke_data_nov2018,
#   by = c("ZCTA5" = "zip_code", "day", "month", "year", "COUNTY_1"))

#generating week variable that starts on Thursday

Smoke_data_2018$week2<-date2week(Smoke_data_2018$date, week_start = 4, floor_day = TRUE)


## summarize hospitalizations by County
CA_hosp_2018_byCounty <- CA_hosp_2018 %>%
  group_by(COUNTY_1, year, month, day, week2) %>%
  summarize(circ= sum(circulatory), resp=sum(respiratory))

Smoke_data_2018_byCounty <- Smoke_data_2018 %>%
  group_by(COUNTY_1, year, month, day, week2, countyname) %>%
  summarize( smoke=mean(wf_pm25 ), tmax=mean(tmmx), prec=mean(pr), hum=mean(spec_humidity), shrtwv_rad=mean(shrtwv_rad), wind=mean(wind.velocity) )

CA_hosp_County <- left_join(  Smoke_data_2018_byCounty, CA_hosp_2018_byCounty,
                              by = c( "day", "month", "year", "COUNTY_1", "week2"))


CA_hosp_County$week<-substr(CA_hosp_County$week2, 7, 8) 

CA_hosp_County<-CA_hosp_County[!(CA_hosp_County$COUNTY_1==0),]

#The only variables with missing data are the hospitalization variables and it's when there's zero of either diagnosis
CA_hosp_County[is.na(CA_hosp_County)] = 0

CA_hosp_County_week37_49 <- CA_hosp_County[which(CA_hosp_County$week>36 & CA_hosp_County$week<49),]


CA_hosp_County_week37_49$Exp<-ifelse(CA_hosp_County_week37_49$week<36, 0,
                                     ifelse(CA_hosp_County_week37_49$week>44, 1, NA))

CA_hosp_County_week45_49<-CA_hosp_County[which(CA_hosp_County$week>44 & CA_hosp_County$week<49),]
CA_hosp_County_week37_44<-CA_hosp_County[which(CA_hosp_County$week>36 & CA_hosp_County$week<45),]

Counties_exp <- CA_hosp_County_week45_49 %>%
  group_by(COUNTY_1) %>%
  summarize( smoke_week45_49=mean(smoke))

# average smoke exposure before wildfires started was very low (less <2 on average)
Counties_exp_beforeSmoke <- CA_hosp_County_week37_44 %>%
  group_by(COUNTY_1) %>%
  summarize( smoke_week37_44=mean(smoke))

CA_hosp_County_week37_49 <- left_join( CA_hosp_County_week37_49, Counties_exp,
                                       by = c("COUNTY_1"))

## CHANGE smoke exposure level here
CA_hosp_County_week37_49$Smokebin<-ifelse(CA_hosp_County_week37_49$smoke_week45_49>=10, 1,
                                          ifelse(CA_hosp_County_week37_49$smoke_week45_49<10, 0, NA))

CA_hosp_County_week37_49_non_exp<-CA_hosp_County_week37_49[which(CA_hosp_County_week37_49$Smokebin==0),]
CA_hosp_County_week37_49_exp<-CA_hosp_County_week37_49[which(CA_hosp_County_week37_49$Smokebin==1),]

# Counties that are exposed
CA_counties_exposed<- CA_hosp_County_week37_49_exp %>%
  group_by(countyname, COUNTY_1) %>%
  summarize(Exposure=mean(Smokebin))

## Comparison of circulatory hospitalizations weeks before and after wildfire smoke started and by exposure
tapply(CA_hosp_County_week37_49$circ,  CA_hosp_County_week37_49$Exp, summary)

tapply(CA_hosp_County_week37_49_non_exp$circ,  CA_hosp_County_week37_49_non_exp$Exp, summary)
tapply(CA_hosp_County_week37_49_exp$circ,  CA_hosp_County_week37_49_exp$Exp, summary)


## Comparison of respiratory hospitalizations weeks before and after wildfire smoke started 
tapply(CA_hosp_County_week37_49$resp,  CA_hosp_County_week37_49$Exp, summary)

tapply(CA_hosp_County_week37_49_non_exp$resp,  CA_hosp_County_week37_49_non_exp$Exp, summary)
tapply(CA_hosp_County_week37_49_exp$resp,  CA_hosp_County_week37_49_exp$Exp, summary)

CA_hosp_County_week37_49$week<- as.numeric(CA_hosp_County_week37_49$week)

# create dataset with sum resp by County
CA_hosp_County_week37_49_byweek <- CA_hosp_County_week37_49 %>%
  group_by(week, COUNTY_1, Smokebin, countyname) %>%
  summarize(resp= sum(resp), tmax=mean(tmax), prec=mean(prec), hum=mean(hum), shrtwv_rad=mean(shrtwv_rad), wind=mean(wind))

# creating final dataset for gsynth analysis
df<-CA_hosp_County_week37_49_byweek


#---------------------------------Generalized synthetic control------------------------------
exposed_counties<- unique(CA_counties_exposed$COUNTY_1)

df_final <-data.frame() 

for (i in 1:length(exposed_counties)) {
  ### create new exposure indicator
  ### 0 for all weeks prior to fire week and 1 only if exposed and during fire week
  df$exp_weekly <- ifelse(df$Smokebin==1& df$week>=45,1,0)
  
  ## keep only one exposed county for test
  df2 <- df[which(df$COUNTY_1==exposed_counties[i]|  df$Smokebin==0),]

  ### check number of unique zip codes
  length(unique(df2$COUNTY_1))
  
  ### factor zip id
  df2$COUNTY_1 <- as.factor(df2$COUNTY_1)
  
  ### implement generalized synthetic control
  gsynth.out <- gsynth(resp ~ exp_weekly + tmax+prec + hum + shrtwv_rad + wind , data = df2, index = c("countyname","week"), 
                       nboots = 500, inference = "parametric", se = TRUE, parallel = TRUE)
  ### view ATT by period
  ATT<-gsynth.out$att.avg
  SE<-gsynth.out$est.avg[,2]

  county<-exposed_counties[i]
  
  result<-cbind(ATT, SE, county)

  df_final = rbind(df_final, result)

  ### gaps plot - difference between treated and counterfactual
  gap_plot<-plot(gsynth.out, type = "gap" , xlab = "Week", ylab="ATT")
  #ggsave(paste0("D:/Lara/wildfires_social_vulnerability/results/", county,"_diff.png"))
  
  ### treated average and estimated counterfactual average outcomesraw = "none", main="",
  plot(gsynth.out, type = "counterfactual",  xlab = "Week", ylab="Average Hospitalizations")
  #ggsave(paste0("D:/Lara/wildfires_social_vulnerability/results/",county,"_counterfactual_avg.png"))
  
}

## save results file
write.csv(df_final, file="D:/Lara/wildfires_social_vulnerability/results/results_smoke_by_County_91224.csv")


#------------------------------Importing and merging census data--------------------#
census_data1 <- read.csv("D:/Lara/wildfires_social_vulnerability/Data/ACSDP5Y2020.DP05_2024-09-12T183616/ACSDP5Y2020.DP05-Data.csv")
census_data1 <- census_data1[-1, ]

census_data2 <- read.csv("D:/Lara/wildfires_social_vulnerability/Data/ACSDP5Y2020.DP03_2024-09-12T183455/ACSDP5Y2020.DP03-Data.csv")
census_data2 <- census_data2[-1, ]

census_data3 <- read.csv("D:/Lara/wildfires_social_vulnerability/Data/ACSDP5Y2020.DP02_2024-09-12T190121/ACSDP5Y2020.DP02-Data.csv")
census_data3 <- census_data3[-1, ]

census_data<- census_data1 %>%
  inner_join(census_data2, by = c( "NAME"))

census_data<- census_data %>%
  inner_join(census_data3, by = c( "NAME"))

census_data$GEO_ID<-census_data$Ã¯..GEO_ID.x
census_data <- subset(census_data, NAME != "California")


census_data$COUNTY_1 <- as.numeric(substr(census_data$GEO_ID, nchar(census_data$GEO_ID) - 1, nchar(census_data$GEO_ID)))

census_data<- census_data %>%
  inner_join(Counties_exp, by = c( "COUNTY_1"))

census_county_level<- census_data %>% 
  mutate(county=substr(GEO_ID, nchar(GEO_ID)-2,nchar(GEO_ID))) 

census_county_level$county<-as.numeric(census_county_level$county)

#select variables of interest for meta-regression
census_county_level$total.pop<- census_county_level$DP05_0001E
census_county_level$X55.59<- census_county_level$DP05_0013E
census_county_level$X60.64<- census_county_level$DP05_0014E
census_county_level$X65.and.over<- census_county_level$DP05_0024E
census_county_level$X85.<- census_county_level$DP05_0017E  
census_county_level$medianage<- census_county_level$DP05_0018E
census_county_level$highschool.grad.or.higher<- census_county_level$DP02_0067PE  
census_county_level$unemployment<- census_county_level$DP03_0005E  
census_county_level$median.household.income<- census_county_level$DP03_0062E
census_county_level$female<- census_county_level$DP05_0003E   
census_county_level$white<- census_county_level$DP05_0037E  
census_county_level$black.or.african.american<- census_county_level$DP05_0038E   
census_county_level$hispanic<- census_county_level$DP05_0071E  
census_county_level$asian<- census_county_level$DP05_0044E   

df_final_social<- left_join(df_final, census_county_level, by = "county") 


write.csv(df_final_social, file="D:/Lara/wildfires_social_vulnerability/results/results_smoke_census_updated_91224.csv")

#------------------------------Meta-regression--------------------#
results_for_metareg <- read.csv("D:/Lara/wildfires_social_vulnerability/results/results_smoke_census_updated_91224.csv")
results_for_metareg<-results_for_metareg[,!names(results_for_metareg) %in% c("X", "ATT", "SE")]

results_for_metareg<- left_join(results_for_metareg, df_final, by = c("county"))

results_for_metareg$ATT_pop_adj<-(results_for_metareg$ATT/results_for_metareg$total.pop)*100000
results_for_metareg$SE_pop_adj<-(results_for_metareg$SE/results_for_metareg$total.pop)*100000

results<-as.data.frame(results_for_metareg)

### Analysis updated 9/12/24
results$per_age_55_over<-((results$X55.59+results$X60.64+results$X65.and.over)/results$total.pop)*100
results$per_age_85_over<-(results$X85./results$total.pop)*100
results$per_age_65_over<-(results$X65.and.over/results$total.pop)*100
results$medianage<-(results$medianage)
results$per_highschool_or_higher<-(results$highschool.grad.or.higher/results$total.pop)*100
results$unemploy<-(results$unemployment/results$total.pop)*100
results$median_incom<-results$median.household.income
results$per_female<-(results$female/results$total.pop)*100
results$per_white<-(results$white/results$total.pop)*100
results$per_black<-(results$black.or.african.american/results$total.pop)*100
results$per_asian<-(results$asian/results$total.pop)*100
results$per_hispanic<-(results$hispanic/results$total.pop)*100

results$ATT_pop_per1000<-(results$ATT/results$total.pop)*100000
results$SE_pop_per1000<-(results$SE/results$total.pop)*100000

results$mean_per_age_55_over <-mean(results$per_age_55_over)
results$mean_per_age_85_over <-mean(results$per_age_85_over)
results$mean_per_age_65_over <-mean(results$per_age_65_over)
results$mean_medianage<-mean(results$medianage)
results$mean_per_highschool_or_higher<-mean(results$per_highschool_or_higher)
results$mean_unemploy<-mean(results$unemploy)
results$mean_median_incom<-mean(results$median_incom)
results$mean_per_female<-mean(results$per_female)
results$mean_per_white<-mean(results$per_white)
results$mean_per_black<-mean(results$per_black)
results$mean_per_asian<-mean(results$per_asian)
results$mean_per_hispanic<-mean(results$per_hispanic)

results$per_age_55_over <-(results$per_age_55_over- results$mean_per_age_55_over)/IQR(results$per_age_55_over)
results$per_age_85_over <-(results$per_age_85_over- results$mean_per_age_85_over)/IQR(results$per_age_85_over)
results$per_age_65_over <-(results$per_age_65_over- results$mean_per_age_65_over)/IQR(results$per_age_65_over)
results$medianage<-(results$medianage- results$mean_medianage)/IQR(results$medianage)
results$per_highschool_or_higher<-(results$per_highschool_or_higher- results$mean_per_highschool_or_higher)/IQR(results$per_highschool_or_higher)
results$unemploy<-(results$unemploy- results$mean_unemploy)/IQR(results$unemploy)
results$median_incom<-(results$median_incom- results$mean_median_incom)/IQR(results$median_incom)
results$per_female<-(results$per_female- results$mean_per_female)/IQR(results$per_female)
results$per_white<-(results$per_white- results$mean_per_white)/IQR(results$per_white)
results$per_black<-(results$per_black- results$mean_per_black)/IQR(results$per_black)
results$per_asian<-(results$per_asian- results$mean_per_asian)/IQR(results$per_asian)
results$per_hispanic<-(results$per_hispanic- results$mean_per_hispanic)/IQR(results$per_hispanic)


# Select the variables of interest
variables <- c("per_age_55_over",  "per_age_65_over", "per_age_85_over","medianage", "per_highschool_or_higher", "median_incom", "unemploy", "per_female", "per_white", "per_black", "per_asian", "per_hispanic")

# Create an empty data frame to store the results
results_metareg <- data.frame(variable = character(),
                              coefficient = numeric(),
                              standard_error = numeric(),
                              stringsAsFactors = FALSE)

# Loop through each variable and perform the meta-regression
for (var in variables) {
  # Subset the data to the relevant columns
  subset_data <- results[, c("ATT_pop_per1000", "SE_pop_per1000","county", var)]

  # Fit the meta-regression model
  m2 <- metagen(TE = ATT_pop_per1000, seTE = SE_pop_per1000, studlab = county, data = subset_data)
  model <- metareg(m2, as.formula(paste0(" ~ ", var)))

  # Extract the coefficient and standard error
  coefficient <- model$beta[2]
  standard_error <- model$se[2]
  
  intercept<-coef(model)[1]
  intercept_error<- sqrt(diag(vcov(model)))[1]
  
  # Append the results to the data frame
  results_metareg <- rbind(results_metareg, data.frame(variable = var, coefficient = coefficient, standard_error = standard_error, intercept=intercept, intercept_error=intercept_error))
}
write.csv(results_metareg, "D:/Lara/wildfires_social_vulnerability/results/metareg_results_91224.csv")




## plot the results
metareg_results <- read_csv("D:/Lara/wildfires_social_vulnerability/results/metareg_results_91224.csv")

metareg_results_plot <- (metareg_results
                         %>% mutate(Variable = factor(variable,
                                                      levels = c("per_female", "per_white", "per_hispanic", "per_black", "per_asian", "per_highschool_or_higher", "per_age_55_over", "per_age_65_over", "per_age_85_over", "medianage", "median_incom", "unemploy"),
                                                      labels = c("Women (%)", "White (%)", "Hispanic (%)", "Black (%)", "Asian (%)", "High school or more (%)", "Age > 55 years (%)", "Age > 65 years (%)", "Age > 85 years (%)", "Median age", "Median income", "Unemployment (%)"))
                         )
                         %>% ggplot()
                         + geom_pointrange(aes(x = coefficient, xmin = coefficient- 1.96*standard_error, xmax = coefficient + 1.96*standard_error, y = Variable))
                         + geom_vline(xintercept = 0, linetype = "dashed", color="red")
                         + xlab("Coefficient for covariates in metaregression of county-level ATTs of exposure\nto 2018 wildfire on respiratory hospitalization counts (per 10000 population)")
                         + theme(axis.text = element_text(size = 14),
                                 axis.title = element_text(size = 16),
                                 panel.grid.major = element_blank(),  # Remove major gridlines
                                 panel.grid.minor = element_blank()  # Remove minor gridlines 
                         ))

## Figure of estimates by County
group_var <- "county"

state_shapes <- read_sf("D:/Lara/wildfires_social_vulnerability/Data/ca_counties/CA_Counties.shp", stringsAsFactors = FALSE, as_tibble = FALSE)
state_shapes$COUNTYFP<-as.numeric(state_shapes$COUNTYFP)
temp_states <- df_final
county_order <- unique(temp_states$county[order(temp_states$ATT)])
temp_states$county <- factor(temp_states$county, levels=county_order)
state_shapes$CVEGEO<-factor(state_shapes$COUNTYFP)
sp_states <- merge(state_shapes, temp_states, by.x = "COUNTYFP", by.y = "county", all.y = TRUE)
col_values_states <- met.brewer("Johnson", n = nrow(sp_states))


# Order sp_states by Coefficient
sp_states <- sp_states[rev(order(sp_states$ATT)), ]

# Get number of states
num_states <- nrow(sp_states)

# Create color palette with higher values in red
col_values_states <- met.brewer("Johnson", n = nrow(sp_states))
col_values_states <- rev(col_values_states)

sp_states <- sp_states %>%
  arrange(ATT) %>%
  mutate(ATT_order = row_number())

# Define a consistent color palette based on ATT
num_colors <- length(unique(sp_states$ATT_order))

col_values <- met.brewer("Johnson", n = num_colors)
col_values <- rev(col_values) # Reverse the colors if needed

# Plot 1: Map ATT to fill color
p1 <- ggplot(sp_states) +
  geom_sf(aes(fill = factor(ATT))) +
  scale_fill_manual(values = col_values, 
                    labels=sp_states$NAME,
                    guide = guide_legend(title = "County", ncol = 3)) +
  labs(x = "", y = "", title = "") +
  theme_bw() 


# Prepare data for Plot 2
temp1 <- sp_states
temp1 <- temp1[order(temp1$ATT), ]
temp1$NAME <- factor(temp1$NAME, levels = temp1$NAME[order(temp1$ATT)])
temp1$NAME <- factor(temp1$NAME, levels = rev(levels(temp1$NAME)))
temp1$upper_ci <- temp1$ATT + (1.96 * temp1$SE)
temp1$lower_ci <- temp1$ATT - (1.96 * temp1$SE)

num_colors <- length(unique(sp_states$ATT_order))
col_values <- met.brewer("Johnson", n = num_colors)

# Use the same color palette in Plot 2
p2 <- ggplot(temp1, aes(y = ATT, col = NAME, x = NAME, ymax = upper_ci, ymin = lower_ci)) + 
  geom_hline(yintercept = 1, size = 1.2) +
  geom_point(position = "dodge", size = 3) + 
  geom_errorbar(position = "dodge", width = 0.2, size = 1.2) + 
  scale_color_manual(values = col_values, na.value = "darkgrey") +
  labs(title = "", x = "County", y = "ATT") + 
  theme_bw() +
  theme(text = element_text(size = 10), legend.position = "none", 
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))



